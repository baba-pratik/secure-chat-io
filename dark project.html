<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE_LINK_V4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap');
        body { background: #000; color: #0f0; font-family: 'Courier Prime', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* CRT Effect */
        body::after { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none; }

        header { padding: 10px; border-bottom: 1px dashed #0f0; display: flex; justify-content: space-between; z-index: 3; }
        #room-display { color: #ff0055; font-weight: bold; }
        
        #messages { flex: 1; list-style: none; padding: 20px; overflow-y: auto; z-index: 3; }
        #messages li { margin-bottom: 8px; word-break: break-word; }
        
        .sys-msg { color: #ffff00; opacity: 0.8; font-size: 0.9em; }
        .usr-name { color: #00d4ff; font-weight: bold; }
        .file-link { color: #fff; background: #003300; padding: 2px 5px; text-decoration: none; border: 1px solid #0f0; }
        .img-preview { max-width: 200px; border: 2px solid #0f0; margin-top: 5px; display: block; }

        #form { display: flex; padding: 10px; border-top: 1px solid #0f0; background: #111; z-index: 3; }
        #input { flex: 1; background: #000; border: none; color: #fff; font-family: inherit; font-size: 1.1em; outline: none; padding: 0 10px; }
        button { background: #0f0; color: #000; border: none; padding: 5px 15px; cursor: pointer; font-weight: bold; font-family: inherit; margin-left: 5px; }
        
        /* Hidden file input */
        #fileInput { display: none; }
    </style>
</head>
<body>
    <header>
        <span>STATUS: ENCRYPTED</span>
        <span id="room-display">CHANNEL: LOBBY</span>
    </header>

    <ul id="messages"></ul>

    <form id="form">
        <span style="color:#0f0; padding-right:5px;">></span>
        <input id="input" autocomplete="off" placeholder="Message..." />
        <button type="button" onclick="document.getElementById('fileInput').click()">[FILE]</button>
        <button>SEND</button>
        <input type="file" id="fileInput" onchange="uploadFile()">
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var myName = prompt("ENTER YOUR CODENAME / ALIAS:", "Guest_" + Math.floor(Math.random()*100));
        
        // Identity bhejo server ko connect hote hi
        socket.emit('set identity', myName);

        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var messages = document.getElementById('messages');

        // Message Send
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                // Command Handling (/join roomname)
                if(input.value.startsWith('/join ')) {
                    const room = input.value.split(' ')[1];
                    socket.emit('join room', room);
                    document.getElementById('room-display').innerText = "CHANNEL: " + room.toUpperCase();
                } else {
                    socket.emit('chat message', input.value);
                }
                input.value = '';
            }
        });

        // Incoming Message
        socket.on('chat message', function(data) {
            var item = document.createElement('li');
            item.innerHTML = `<span class="usr-name"><${data.user}></span>: ${data.text}`;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // System Message
        socket.on('system', function(msg) {
            var item = document.createElement('li');
            item.classList.add('sys-msg');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // File Receive Logic
        socket.on('file received', function(data) {
            var item = document.createElement('li');
            let content = '';
            if (data.fileType.startsWith('image/')) {
                content = `<br><img src="${data.buffer}" class="img-preview">`;
            } else {
                content = `<br><a href="${data.buffer}" download="${data.fileName}" class="file-link">[DOWNLOAD: ${data.fileName}]</a>`;
            }
            item.innerHTML = `<span class="usr-name"><${data.user}></span>: [SENT FILE] ${content}`;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // File Upload Logic
        function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            if(file && file.size < 5 * 1024 * 1024) { // 5MB Limit
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('upload', { fileName: file.name, fileType: file.type, buffer: e.target.result });
                };
                reader.readAsDataURL(file);
            } else {
                alert("File too big (Max 5MB)");
            }
        }
    </script>
</body>
</html>